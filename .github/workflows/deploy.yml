name: Deploy to GCE VM

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_DIR: /home/steamdb_ynov/steamdb

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Préparer la cible (sans sudo)
      - name: Prepare target folder (no sudo)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script_stop: true
          envs: APP_DIR
          script: |
            set -eu
            APP_DIR="${APP_DIR:-$HOME/steamdb}"
            echo "[INFO] Preparing ${APP_DIR} on $(hostname) as $(whoami)"
            mkdir -p "$APP_DIR"
            rm -rf "$APP_DIR/.git"
            find "$APP_DIR" -mindepth 1 -maxdepth 1 -exec rm -rf {} +
            mkdir -p "$APP_DIR"

      # 2) Upload (whitelist => pas de .git)
      - name: Upload project to VM (whitelist)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          target: "${{ env.APP_DIR }}"
          overwrite: true
          source: |
            docker-compose.yml
            requirements.txt
            apps.txt
            dags
            etl
            streamlit

      # 3) Déployer + trigger DAG (sans EOF)
      - name: Deploy and trigger Airflow
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script_stop: true
          command_timeout: 60m
          envs: APP_DIR,GCP_PROJECT,GCS_BUCKET,FIRESTORE_PROJECT,GCP_SA_KEY
          script: |
            set -eu
            APP_DIR="${APP_DIR:-$HOME/steamdb}"
            cd "$APP_DIR"

            # Fallback Firestore -> GCP_PROJECT si vide
            if [ -z "${FIRESTORE_PROJECT:-}" ]; then FIRESTORE_PROJECT="${GCP_PROJECT}"; fi

            # Ecrire .env sans heredoc
            printf "GCP_PROJECT=%s\n" "${GCP_PROJECT}" > .env
            printf "GCS_BUCKET=%s\n"  "${GCS_BUCKET}"  >> .env
            printf "FIRESTORE_PROJECT=%s\n" "${FIRESTORE_PROJECT}" >> .env
            printf "AIRFLOW_PORT=8081\nSTREAMLIT_PORT=8501\n" >> .env
            echo "[INFO] .env written:"
            cat .env

            # Déposer la clé de service (optionnelle) sans heredoc
            if [ -n "${GCP_SA_KEY:-}" ]; then
              # écrit le JSON tel quel
              printf "%s" "${GCP_SA_KEY}" > gcp-sa.json
              chmod 600 gcp-sa.json
              echo "[INFO] gcp-sa.json created"
            fi

            # Choisir la commande compose (sans sudo)
            if docker compose version >/dev/null 2>&1; then
              DC="docker compose"
            elif command -v docker-compose >/dev/null 2>&1; then
              DC="docker-compose"
            else
              echo "[ERROR] docker compose / docker-compose introuvable sur la VM."
              exit 1
            fi

            # (Re)lancer
            $DC pull || true
            $DC down || true
            $DC up -d
            $DC ps

            # Trigger DAG
            sleep 10
            $DC exec -T airflow airflow dags unpause steam_etl_gcp || true
            $DC exec -T airflow airflow dags trigger steam_etl_gcp || true

            echo "[INFO] Tail airflow logs (last 100 lines)"
            $DC logs --tail=100 airflow || true

- name: Deploy to VM via SSH
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: ${{ secrets.GCP_HOST }}
    username: ${{ secrets.GCP_USER }}
    key: ${{ secrets.GCP_SSH_KEY }}     # <-- clé privée en clair (avec retours à la ligne)
    port: ${{ secrets.SSH_PORT || 22 }}
    script_stop: true
    script: |
      set -e
      APP_DIR="${{ secrets.APP_DIR }}"
      if [ -z "$APP_DIR" ]; then
        APP_DIR="/home/${{ secrets.GCP_USER }}/steamdb"
      fi
      if [ ! -d "$APP_DIR/.git" ]; then
        git clone https://github.com/${{ github.repository }} "$APP_DIR"
      fi
      cd "$APP_DIR"
      git fetch --all --prune
      REF="${{ github.event.workflow_run.head_sha || github.sha }}"
      BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"
      git checkout "$BRANCH" || git checkout -b "$BRANCH"
      git reset --hard "$REF"
      docker compose pull || true
      docker compose down || true
      docker compose up -d
      docker compose ps
